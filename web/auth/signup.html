<html>
    <head>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body>

        <div id="modal" class="modal modal-fixed-footer">
            <div class="modal-content">
            <h4 id="modal_title"></h4>
            <p id="modal_text"></p>
            </div>
            <div class="modal-footer">
            <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat ">OK</a>
            </div>
        </div>


	     
        <div class="container">
            <div class="row">
                <form id="signup" action="/" class="col s12">
                    <div class="row">
                        <div class="input-field col s6">
                            <input id="first_name" type="text" autocomplete="off" class="validate">
                            <label for="first_name">First Name</label>
                        </div>
                        <div class="input-field col s6">
                            <input id="last_name" type="text" autocomplete="off" class="validate">
                            <label for="last_name">Last Name</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="email" type="email" autocomplete="off" class="validate">
                            <label for="email">Email</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input id="password" type="password" class="validate">
                            <label for="password">Password</label>
                        </div>
                    </div>
					<div class="row">
						<div class="input-field col s12">
							<input id="invite_code" type="text" autocomplete="off" class="validate">
							<label for="invite_code">Invite Code</label>
						</div>
					</div>
					<button class="btn waves-effect waves-light" type="submit" name="action">Submit
						<i class="material-icons right">send</i>
					</button>
                </form>
            </div>

			<h1>Leaderboard</h1>
			<ul id="leaderboard" class="collection"></ul>
			<p></p>

        </div>


        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>
        <script type="text/javascript">
            $.extend({
                getUrlVars: function(){
                    var vars = [], hash;
                    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                    for(var i = 0; i < hashes.length; i++)
                    {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                    }
                    return vars;
                },
                getUrlVar: function(name){
                    return $.getUrlVars()[name];
                }
            });
        </script>
		<script type="text/javascript">


		    $(document).ready(function() {
                var code = $.getUrlVar("code");
                if (code != "") {
                    $("#invite_code").val(code);
                }

                $("#success_modal").modal();

				$.ajax({
					type: "GET",
					url: "/leaderboard",
					success: function(data) {
						data.forEach(function(d, i) {
							$("#leaderboard").append(`
								<li class="collection-item avatar">
									<img src=`+d.avatarUrl+` alt="" class="circle">
									<span class="title">`+d.name+`</span>
									<p>Invite Count: `+d.count+`</p>
									<a href="#!" class="secondary-content">
                                        <i class="material-icons">grade</i>
                                    </a>
                                </li>
							`)
						})
					}
				});

				$("#signup").submit(function(e) {
					var fullName = $("#first_name").val() + " " + $("#last_name").val()
					var formData = {
						fullName: fullName,
						email: $("#email").val(),
						password: $("#password").val(),
						passwordConfirm: $("#password").val(),
						inviteCode: $("#invite_code").val(),
					};

					$.ajax({
						type: "POST",
						url: "/signup",
						data: JSON.stringify(formData),
						success: function(resp) {
                            $("#modal #modal_title").text("Success!");
                            $("#modal #modal_text").text("Thanks for signing up!")
                            $("#modal").modal("open");
                            setTimeout(function() {
                                $("#modal").modal("close")
                            }, 1500)

                            // reset forms
                            $("#first_name").val("")
                            $("#last_name").val("")
                            $("#email").val("")
                            $("#password").val("")
                            $("#password").val("")
                            $("#invite_code").val("")
						},
                        error: function(resp) {
                            let obj = JSON.parse(resp.responseText)
                            $("#modal #modal_title").text("Ops! Something went wrong!");
                            $("#modal #modal_text").text(obj["error"]);
                            $("#modal").modal("open");
                        },
						complete: function() {
                            // on complete
						}
					});

					e.preventDefault();
				})
			})
		</script>
    </body>
</html>
